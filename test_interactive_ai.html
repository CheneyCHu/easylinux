<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•äº¤äº’å¼AI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .waiting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        input, textarea, button { width: 100%; padding: 10px; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .response { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin: 10px 0; }
        pre { background: #e9ecef; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>äº¤äº’å¼AIæµ‹è¯•é¡µé¢</h1>
        
        <div class="status info">
            <strong>è¯´æ˜ï¼š</strong>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•WebSSHçš„äº¤äº’å¼AIåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
        </div>

        <div id="connectionStatus" class="status error">
            <strong>çŠ¶æ€ï¼š</strong>æœªè¿æ¥åˆ°WebSSHæœåŠ¡
        </div>

        <div>
            <label for="sessionId">ä¼šè¯IDï¼ˆéœ€è¦å…ˆåœ¨WebSSHä¸­è¿æ¥ä¸€ä¸ªä¸»æœºï¼‰ï¼š</label>
            <input type="text" id="sessionId" placeholder="è¾“å…¥SSHä¼šè¯ID">
        </div>

        <div>
            <label for="userMessage">ç”¨æˆ·æ¶ˆæ¯ï¼š</label>
            <textarea id="userMessage" rows="3" placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ"></textarea>
        </div>

        <div>
            <button onclick="sendUserRequest()" id="sendBtn">å‘é€ç”¨æˆ·è¯·æ±‚</button>
        </div>

        <div>
            <label for="executionResult">æ‰§è¡Œç»“æœåé¦ˆï¼š</label>
            <textarea id="executionResult" rows="3" placeholder="è¾“å…¥å‘½ä»¤æ‰§è¡Œç»“æœï¼Œä¾‹å¦‚ï¼šæ‰§è¡ŒæˆåŠŸï¼Œè¾“å‡ºæ˜¾ç¤ºCPUä½¿ç”¨ç‡20%"></textarea>
        </div>

        <div>
            <button onclick="sendExecutionResult()" id="feedbackBtn" disabled>æäº¤æ‰§è¡Œç»“æœ</button>
        </div>

        <div id="responses"></div>
    </div>

    <script>
        let currentCommandId = 0;
        let waitingExecution = false;

        // æ£€æŸ¥æœåŠ¡è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                const response = await fetch('http://localhost:8899/api/ai/providers');
                if (response.status === 401) {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<strong>çŠ¶æ€ï¼š</strong>WebSSHæœåŠ¡è¿è¡Œä¸­ï¼Œä½†éœ€è¦ç™»å½•è®¤è¯ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰';
                    document.getElementById('connectionStatus').className = 'status success';
                } else {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<strong>çŠ¶æ€ï¼š</strong>WebSSHæœåŠ¡è¿æ¥å¼‚å¸¸';
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    '<strong>çŠ¶æ€ï¼š</strong>æ— æ³•è¿æ¥åˆ°WebSSHæœåŠ¡(localhost:8899)ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨';
            }
        }

        // å‘é€ç”¨æˆ·è¯·æ±‚
        async function sendUserRequest() {
            const sessionId = document.getElementById('sessionId').value.trim();
            const userMessage = document.getElementById('userMessage').value.trim();

            if (!sessionId || !userMessage) {
                alert('è¯·å¡«å†™ä¼šè¯IDå’Œç”¨æˆ·æ¶ˆæ¯');
                return;
            }

            const requestData = {
                session_id: sessionId,
                user_message: userMessage,
                message_type: 'user_request'
            };

            addResponse('ç”¨æˆ·è¯·æ±‚', userMessage, 'info');

            try {
                const response = await fetch('http://localhost:8899/api/ai/interactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test' // éœ€è¦å®é™…çš„JWT token
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                handleResponse(result, 'AIå“åº”');

                if (result.code === 0 && result.data.session_status === 'waiting_execution') {
                    waitingExecution = true;
                    currentCommandId = result.data.command_id;
                    document.getElementById('feedbackBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = true;
                    addResponse('ç³»ç»Ÿæç¤º', 'ğŸ”¶ AIå·²ç”Ÿæˆå‘½ä»¤å»ºè®®ï¼Œç­‰å¾…æ‰§è¡Œç»“æœåé¦ˆ', 'waiting');
                }
            } catch (error) {
                addResponse('é”™è¯¯', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€æ‰§è¡Œç»“æœ
        async function sendExecutionResult() {
            const sessionId = document.getElementById('sessionId').value.trim();
            const executionResult = document.getElementById('executionResult').value.trim();

            if (!sessionId || !executionResult || !currentCommandId) {
                alert('è¯·å¡«å†™ä¼šè¯IDå’Œæ‰§è¡Œç»“æœ');
                return;
            }

            // ç®€å•è§£ææ‰§è¡Œç»“æœ
            const success = /æˆåŠŸ|å®Œæˆ|success|ok|æ­£å¸¸|done/i.test(executionResult);
            
            const requestData = {
                session_id: sessionId,
                user_message: executionResult,
                message_type: 'execution_result',
                execution_info: {
                    command_id: currentCommandId,
                    success: success,
                    output: success ? executionResult : '',
                    error: success ? '' : executionResult
                }
            };

            addResponse('æ‰§è¡Œç»“æœåé¦ˆ', executionResult, 'info');

            try {
                const response = await fetch('http://localhost:8899/api/ai/interactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test' // éœ€è¦å®é™…çš„JWT token
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                handleResponse(result, 'AIåˆ†æå“åº”');

                if (result.code === 0) {
                    const status = result.data.session_status;
                    if (status === 'completed') {
                        addResponse('ç³»ç»Ÿæç¤º', 'âœ… ä¼šè¯å·²å®Œæˆï¼', 'success');
                        resetForm();
                    } else if (status === 'waiting_execution') {
                        currentCommandId = result.data.command_id;
                        addResponse('ç³»ç»Ÿæç¤º', 'ğŸ”¶ AIæä¾›äº†æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·ç»§ç»­æ‰§è¡Œ', 'waiting');
                    } else if (status === 'failed') {
                        addResponse('ç³»ç»Ÿæç¤º', 'âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥', 'error');
                        resetForm();
                    }
                }
            } catch (error) {
                addResponse('é”™è¯¯', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¤„ç†å“åº”
        function handleResponse(result, title) {
            if (result.code === 0) {
                addResponse(title, JSON.stringify(result.data, null, 2), 'success');
            } else {
                addResponse(title, `é”™è¯¯: ${result.msg}`, 'error');
            }
        }

        // æ·»åŠ å“åº”æ˜¾ç¤º
        function addResponse(title, content, type) {
            const responsesDiv = document.getElementById('responses');
            const responseDiv = document.createElement('div');
            responseDiv.className = 'response';
            
            const time = new Date().toLocaleTimeString();
            responseDiv.innerHTML = `
                <h4>${title} (${time})</h4>
                <pre>${content}</pre>
            `;
            
            responsesDiv.appendChild(responseDiv);
            responseDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            waitingExecution = false;
            currentCommandId = 0;
            document.getElementById('feedbackBtn').disabled = true;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('userMessage').value = '';
            document.getElementById('executionResult').value = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
    </script>
</body>
</html> 